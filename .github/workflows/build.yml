on: [push]

name: CI

jobs:
  test:
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        include:
          - os: macos-latest
            cargo: sudo -E /Users/runner/.cargo/bin/cargo
            protoc-target: osx-x86_64
          - os: ubuntu-latest
            cargo: sudo -E /home/runner/.cargo/bin/cargo
            protoc-target: linux-x86_64
          - os: windows-latest
            cargo: cargo
            protoc-target: win64
      fail-fast: false
    name: Build and test
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      - uses: Swatinem/rust-cache@v2
        with:
          shared-key: cache-${{ hashFiles('**/Cargo.toml') }}
      - name: Install Gtk (ubuntu only)
        if: ${{ matrix.os }} == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev
      - name: test
        env:
          PROTOC: ${{ github.workspace }}/protoc/bin/protoc
        run: |
          curl -LO https://github.com/protocolbuffers/protobuf/releases/download/v3.19.4/protoc-3.19.4-${{ matrix.protoc-target }}.zip
          unzip protoc-3.19.4-${{ matrix.protoc-target }}.zip -d "${{ github.workspace }}/protoc"
          cargo install cargo-make
          cargo make build-all
          cargo make build-examples
          ${{ matrix.cargo }} test --workspace -- --nocapture
