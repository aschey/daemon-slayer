on: [push]

name: CI

jobs:
  test:
    strategy:
      matrix:
        include:
          - os: macos-13
            test: sudo cargo make test-admin
          - os: macos-13
            test: cargo make test
          - os: macos-12
            test: sudo cargo make test-admin
          - os: macos-12
            test: cargo make test
          - os: macos-11
            test: sudo cargo make test-admin
          - os: macos-11
            test: cargo make test
          - os: ubuntu-latest
            test: sudo -E env PATH="$PATH" cargo make test-admin
          - os: ubuntu-latest
            test: cargo make test
          - os: windows-latest
            test: cargo make test-admin
      fail-fast: false
    name: Run ${{ matrix.test }} on ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - uses: Swatinem/rust-cache@v2
        with:
          key: "${{ matrix.test }}-${{ matrix.os }}"
      - name: Install extra deps (ubuntu only)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev webkit2gtk-4.0 libayatana-appindicator3-dev librsvg2-dev libxdo-dev
      - name: clippy
        run: cargo clippy --all-features
      - name: test
        run: |
          cargo install cargo-make
          cargo make build-all
          ${{ matrix.test }}
